{% extends "Spotify/base.html" %}
{% load static %}

{% block title %}Perfil - Spotify Rewind{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'Spotify_app/css/profile_style.css' %}">

<div id="background-image-container">
    <img id="background-image" crossorigin="anonymous" alt="">
</div>

<a href="{% url 'logout' %}" class="back-button">
    ← Sair
</a>

<div class="container">
    <div class="tracks-container">
        <!-- As músicas serão renderizadas aqui pelo JavaScript -->
    </div>
</div>

<script>
    // Dados das top tracks do usuário vindos do Django
    const tracks = [
        {% for track in top_tracks %}
        {
            id: {{ forloop.counter }},
            name: "{{ track.name|escapejs }}",
            artist: "{% for artist in track.artists %}{{ artist.name }}{% if not forloop.last %}, {% endif %}{% endfor %}",
            image: "{% if track.album.images %}{{ track.album.images.0.url }}{% else %}https://via.placeholder.com/300x300/1a1917/f8f5f2?text=No+Image{% endif %}"
        }{% if not forloop.last %},{% endif %}
        {% empty %}
        {
            id: 1,
            name: "Nenhuma música encontrada",
            artist: "Faça login novamente",
            image: "https://via.placeholder.com/300x300/1a1917/f8f5f2?text=No+Music"
        }
        {% endfor %}
    ];

    document.addEventListener("DOMContentLoaded", function () {
        const tracksContainer = document.querySelector(".tracks-container");
        const backgroundImage = document.getElementById("background-image");
        
        renderTracks(tracksContainer);
        initialAnimation();
        preloadImages();
        setupHoverEvents(backgroundImage, tracksContainer);
    });

    function renderTracks(container) {
        tracks.forEach((track, index) => {
            const trackItem = document.createElement("div");
            trackItem.classList.add("track-item");
            trackItem.dataset.id = track.id;
            trackItem.dataset.image = track.image;

            trackItem.innerHTML = `
                <div class="track-name">${track.name}</div>
                <div class="track-artist">${track.artist}</div>
            `;

            container.appendChild(trackItem);
        });
    }

    function initialAnimation() {
        const trackItems = document.querySelectorAll(".track-item");
        
        trackItems.forEach((item, index) => {
            item.style.opacity = "0";
            item.style.transform = "translateY(20px)";
            
            setTimeout(() => {
                item.style.transition = "opacity 0.8s ease, transform 0.8s ease";
                item.style.opacity = "1";
                item.style.transform = "translateY(0)";
            }, index * 60);
        });
    }

    function setupHoverEvents(backgroundImage, tracksContainer) {
        const trackItems = document.querySelectorAll(".track-item");

        trackItems.forEach((item) => {
            item.addEventListener("mouseenter", function () {
                const imageUrl = this.dataset.image;

                backgroundImage.style.transition = "none";
                backgroundImage.style.transform = "scale(1.2)";
                backgroundImage.src = imageUrl;
                backgroundImage.style.opacity = "1";

                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        backgroundImage.style.transition = "transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)";
                        backgroundImage.style.transform = "scale(1.0)";
                    });
                });
            });
        });

        tracksContainer.addEventListener("mouseleave", function () {
            backgroundImage.style.opacity = "0";
        });
    }

    function preloadImages() {
        tracks.forEach((track) => {
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.src = track.image;
        });
    }
</script>
{% endblock %}








